# 概念整理

## 协议

| 协议名      | 工作在     | 功能                                               | 基于协议 |
| ----------- | ---------- | -------------------------------------------------- | -------- |
| DHCP        | 应用层     | 分配ip地址                                         | UDP      |
| UDP         | 传输层     | 无连接传输报文                                     | /        |
| ARP         | 网络层     | 根据ip地址查询对应MAC地址，没有则广播              |          |
| IP          | 网络层     | ip数据报解析                                       |          |
| 以太网802.3 | 数据链路层 | 以太网帧                                           |          |
| CSMA/CD     | MAC子层    | 对信道总线进行访问控制                             |          |
| TCP         | 传输层     | 端到端的有连接的传输                               | IP       |
| HTTP        | 应用层     | 规定主机如何向万维网请求                           | TCP      |
| DNS         | 应用层     | 解析域名                                           | UDP      |
| RIP         | 应用层     | 定期维护和更新本网络内的路由信息，保存跳数少的路径 | UDP      |
| OSPF        | 网络层     | 链路状态发生改变时，更新路由信息，保存最短路径     | IP       |
| BGP         | 应用层     | 建立自治系统之间的连接                             | TCP      |
| PPP         | 数据链路层 |                                                    |          |
| NAT         |            | 网络地址转换，解决IPV4地址枯竭问题                 |          |
| ICMP        | IP层       |                                                    |          |



考虑用户请求万维网的完整过程：

①运行DHCP协议，从本地DHCP服务器获取一个IP地址和其它信息：

1）OS生成DHCP请求报文，将其放入传输层的 目的端口：67（DHCP服务器），源端口：68 的UDP报文段

2）在网络层，UDP报文段被放入 目的地址：广播地址 ， 源地址：0.0.0.0（由于此时用户的主机还没有分配到IP地址）的IP数据报中

3）到数据链路层，IP数据报被放到目的MAC地址：ff:ff:ff:ff:ff:ff ，源地址：12:34:56:78:9A:BC(随便想的)的以太网数据帧中，能使交换机该帧广播到所有相连的设备

4）交换机将该帧广播到该局域网的对应路由器的对应端口，从中分离出IP数据报，其中的广播地址代表其应有更高层协议处理，即UDP协议，DHCP请求报文被从UDP报文中抽离。因此DHCP服务器获取到请求报文

5）DHCP服务器为其分配一个IP地址，生成包含 分配的IP地址、DNS服务器的IP地址、默认网关路由器的IP地址、子网块（即CIDR块）的DHCP确认报文。

6）DHCP确认报文被放入UDP报文段，目的端口为68，源端口为67。UDP报文段被放入目的地址为广播地址，源地址为DHCP服务器的IP地址 的IP数据报。该数据报被放入目的MAC地址：12:34:56:78:9A:BC，源地址：路由器向局域网一侧的接口MAC地址的以太网帧

7）交换机收到DHCP确认报文，直接从对应接口转发出去（因为交换机自学习算法，之前主机广播时，知道主机对应的MAC地址和对应的接口号）

８）用户主机收到DHCP请求报文，抽取出被分配到的ＩＰ地址和其对应DNS服务器的ＩＰ地址，并在其ＩＰ转发表中安装默认网关的地址



②获取路由器的MAC地址，将DNS查询帧发送给路由器

1）主机OS生成DNS查询报文，将域名放入报文的问题段，将DNS报文段放在UDP报文段中，目的port:53

2）将上述UDP报文段放入IP数据报，目的地址为①-5中的DNS服务器IP地址，源地址为主机ip地址

3）将IP数据报放入以太网帧中，将该帧发送给网关路由器，但是只知道其IP地址，并不知道网关路由器的MAC地址

4）因此使用ARP协议，广播ARP查询报文，目的IP地址为网关路由器的IP，将该报文放到目的MAC为广播地址的以太网帧中。主机向交换机发送该以太网帧，交换机将该帧广播给所有连接设备，包括网关路由器

5）路由器收到该帧后，解析该帧中的IP数据报，发现目的IP地址与自己的连接交换机一侧的接口的ip地址相同，因此收下，并准备回应。路由器准备一个ARP回答报文，将其自己的MAC地址和IP地址对应放在以太网帧中，目的MAC为用户主机MAC

６）主机收到该以太网帧，从ARP回答报文中抽取出网关路由器的MAC地址。此时可以将DNS查询帧先发送给交换机，再将其交给网关路由器



③解析域名

1）网关路由器收到DNS查询帧，抽取出DNS查询IP数据报，查看其目的地址，发现是域外的路由器，则通过链路将查询帧发送给该域的代理人路由器。该路由器收到帧后，抽取出数据报，查看目的地址，再根据自身的转发表，确定要转发出去的接口，接着将IP数据报转发给DNS服务器。转发表已根据路由协议填写完毕

2）DNS服务器收到了DNS查询数据报（注意是数据报，而非数据帧！）。DNS服务器从中抽取出DNS查询报文，从查询报文中获取要解析的域名。接着，DNS服务器再其数据库中查找域名对应的服务器的IP地址，并生成一个DNS回答报文，将查询到的IP地址放入其中，并将该报文段放入IP数据报中，将IP数据报通过原来的路径发送回主机

3）主机收到该报文，解析出域名的服务器的IP地址。准备正式访问



④与服务器交互

1）与对应域名的服务器之间生成TCP套接字：通过生成TCP SYN报文段，port为80，并将该报文段放入目的地址为服务器IP地址的IP数据报中，再将该数据报放入**MAC地址为网关路由器MAC地址**（ARP协议，考点注意）的数据帧中，并将该数据帧发给直连的交换机。该交换机将数据帧发送给网关路由器

２）网关路由器根据BGP协议确定转发表并将IP数据报发送给目标域名服务器，从数据报中抽取TCP SYN报文段，继续分解到与端口80相联系的欢迎套接字。因此该HTTP服务器和用户主机之间生成一个TCP连接套接字。HTTP服务器生成一个TCP SYNACK报文段，放入目的地址为用户主机IP地址的IP数据报中，并继续放入MAC地址为其网关路由器MAC地址的数据帧中，交给直连交换机

3）用户主机收到TCP SYNACK报文段。分解得到TCP套接字，进入连接状态

4）借助TCP套接字，主机的浏览器生成一个包含要获取的URL的HTTP　GET报文，并将该报文放入套接字中，因此GET报文就称为TCO报文段的第一个载荷，再重复上述传输操作，最终到达HTTP服务器。

５）HTTP服务器从套接字中读取HTTP　GET报文段，生成一个HTTP响应报文，并将主机请求的Web内容放入该报文中

6）HTTP响应报文到达用户主机。浏览器程序从套接字读取HTTP响应报文，抽取web网页的html，并进行显示



## 网络模型

### 1.TCP/IP协议栈

- 应用层，传输层，网际层（不可靠的无连接的数据报服务），网络接口层



### 2.OSI

- 应用层、表示层（数据解释、数据表示变换）、会话层（管理主机间的会话、数据交换的界定和同步）、运输层（端到端（进程），流量控制、差错控制）、网络层（路由选择）、

  链路层（结点到结点（主机），流量控制、差错控制、成帧）、物理层

- 最大的贡献：精确定义了服务（下为上提供）、协议（语法、语义、同步）、接口

### 3.区别

- OSI在传输层仅支持面向连接，TCP/IP在传输层支持两种；OSI在网络层支持两种，TCP/IP在网际层仅支持无连接
- TCP/IP没有在服务、协议和接口上进行区分



## 交换技术

### 1.电路交换





### 2.报文交换

对于报文交换：由于“存储转发”，转发设备需要等一个**报文中的所有数据**都到达后再进行转发

而分组只需要**一个分组**完全到达后就可以进行转发；

每进行一次转发都会增加一次的传输时延

### 3.分组交换

1）数据报

- 无连接，不可靠
- 每个分组独立选择路由，不按序到达
- 分组中包含源地址和目的地址

**注：选择的路由有n个路由器，有k个分组，则需要传输k+n次，在忽略传播时延的情况下，总时间=（n+k）*单个分组的传输时延**

2）虚电路

- 建立逻辑上的虚电路，对应现实中的**唯一**物理路径，即所有都得在这条路径上按序走
- 有连接，可靠
- 除初次建立的分组包含目的地址，后面的分组都不包含目的地址，包含虚电路标识符（虚电路号）
- 致命缺点：所有经过故障结点的虚电路无法正常工作
- 各分组按序到达
- 动态分配带宽，随时可能会增长，因此不需要预分配带宽


# I/O接口和设备

## I/O接口：

1. I/O接口是一种**设备控制器**（特别注意**控制器！**）判断是不是I/O接口

2. I/O接口的组成：（1）CPU与控制器接口：包含三条信号线**（其中数据线既传输数据，又传输设备状态信息和cpu的控制命令（包括中断信号和类型号））**，数据寄存器，控制/状态寄存器

   ​							 （2）I/O逻辑（对控制命令和地址码进行译码，选择相应设备进行控制）

   ​                             （3）控制器与设备接口（在一个控制器中有一个或多个，连接多个设备）

   

3. I/O端口及其编址方式：是**可被CPU直接访问的寄存器**，主要包括数据、状态、控制**三类**寄存器

   ​                                      访问方式：（1）独立编址：使用独立的地址空间，但是**地址码与普通访存地址码无法区分**，因此要使用专门                      的I/O指令来访问

   ​                                                         （2）统一编址：使用和存储器相同的地址空间，通常在**内存中**分配一块**固定的地址**

## I/O方式：

### **1. 程序循环查询**

- 工作过程：CPU启动I/O设备后，**暂停现行程序**，去**一直**执行查询设备的程序，直到设备准备就绪
- 特点：易于实现；但CPU和IO设备只能串行工作，效率低下

### **2. 程序中断**

**响应中断的条件：**

- CPU开中断

- 一条指令执行完且没有更紧迫的任务

- 中断源请求

中断响应周期和中断服务周期：

- 中断响应周期指CPU对中断作出响应到开始处理的时间
- 中断服务周期指CPU发现中断到处理完毕的时间
- 因此，服务周期包括响应周期

**中断响应过程**

- 设备完成数据传输的准备工作后，**才**发出中断请求信号

- cpu在当前**指令周期结束后**并且在**开中断**的情况下，根据中断的优先级，进入**中断响应周期**。

- 先由**中断隐指令（硬件）**依次完成【关中断、保存断点、中断向量】，**到这里称为中断响应**，

- 再由**中断服务程序（软件，os在核心态）**完成【保护现场()、开中断、中断事件处理、关中断、恢复现场、开中断、中断返回】（**说明在核心态下，cpu也能检测和响应中断**）

  **注意，上述服务程序是在多中断的条件下，如果是单级中断系统，中断服务程序不允许打断，因此不需要关中断及其之后的开中断**

**数据传送由中断服务程序完成！**

上述过程，CPU都参与了

**特点：**



**计算时：一般一次只传送一个字数据（以DR的位数），就产生一次中断。这就要求一次中断响应和执行时间 < I/O设备的数据准备时间，否则DR中的数据会被下一次准备好的数据刷新**



- 多重中断：要求开中断；优先级高的中断源可以中断优先级低的中断源
- 中断屏蔽

### **3. DMA（Direct Memory Access）**

- **DMA控制器：**

功能：

1、接受IO设备的请求，并向CPU发出总线请求

2、确定传送数据的主存地址和长度；修改主存地址计数和传送长度计数

3、发出读写控制信号、执行数据传送

组成：

1、MM地址计数器：存储要访问的主存地址

2、传送长度计数器：传送数据的长度。计数溢出时，发出中断信号，说明已经传送完成

3、中断机构：一个数据块传送完成后，向CPU提出中断请求

4、DMA请求触发器：IO设备准备好数据后，给出一个控制信号，使DMA请求触发器置位

5、buffer

6、控制/状态逻辑：

- **DMA传送过程**

（1）I/O设备准备好数据后（即IO接口中的数据缓冲寄存器），**DMA控制器**向CPU发出DMA请求。CPU通过执行**设备驱动程序**给DMA控制器设置参数，启动DMA控制器，并将总线控制权暂时交给DMA控制器，

（2）由DMA控制器**完全负责**数据传送过程，**一次只传送一个字**，直到一个数据块中的数据全部被传送完。

（3）结束后，DMA向CPU发出中断请求，CPU执行中断服务程序校验数据是否正确

其中，（2）DMA数据传送方式分为：

（1）DMA独占主存：此时CPU不能访存，直到**一个数据块**传送结束

（2）DMA周期挪用：

- CPU正在访存：要等CPU的存取周期结束后，CPU将总线占有权让出

- IO和CPU同时访存时：I/O访存优先级**高于**CPU（如果不及时响应，IO数据可能会丢失，被下一次设备传输过来的数据覆盖）。传送完**一个字数据**就释放总线，让CPU访存

（3）交替访存：当CPU的工作周期 > 访存周期时，

|              | 中断IO               | DMA                                          |
| ------------ | -------------------- | -------------------------------------------- |
| 数据传送     | 通过程序             | 硬件                                         |
| 优先级       | 低                   | 高                                           |
| CPU参与      | 传送过程和中断都需要 | 只在预处理和传送完后处理需要CPU              |
| 时机         | 指令执行周期后       | 总线周期后/机器周期？                        |
| 适用性       | 有中断控制器的       | 有DMA接口的                                  |
| 谁控制       | CPU                  | DMA控制器                                    |
| 适合的设备   | 键盘、鼠标、打印机   | 高速设备大批量的数据传送（磁盘、显卡、网卡） |
| 异常处理能力 | 具备                 | 无                                           |

**适用性？思考**
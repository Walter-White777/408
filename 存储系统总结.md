# 存储系统

## 概述

### 1.分类

- 层次：MM；外存；cache

- 存取方式：RAM和ROM**都属于**随机存取；

  ​				顺序存取：存取时间与存储的物理位置有关；如磁带

  ​				直接存取：介于随机存取和顺序存取之间，先随机存取一个小区域，在小区域内顺序；如磁盘，光盘

- 易失性：RAM断电易失，ROM不易失



### 2.性能指标

存取时间：启动到完成操作的时间

存取周期：进行一次**完整的读或写**操作的时间。区别于存取时间，存取周期还包括恢复时间

### 3.存储系统层次

- cache-MM:数据流动由硬件自动完成，对所有用户透明
- MM-外存：数据流动由硬件和OS共同完成，对**系统程序员**可见



## 主存

**结构：**

- cache（SRAM）
- 内存模块（DRAM）
- 主板上的ROM芯片

### 1.RAM

（1）SRAM

- 双稳态触发器（MOS管），不需要刷新

- 用于Cache

（2）DRAM

- 每个bit为一个栅极电容，上面的电荷只能维持1-2ms，因此需要定时刷新：

  1）集中刷新 2）分散刷新 3）异步刷新。

  刷新单位为行（块），所有芯片**同时**刷新。刷新相当于读和写两次存取操作

- DRAM芯片由rxc个超单元(即为字)组成，每个超单元由w个DRAM单元组成（一般w为8，即8bits）

- 读写时先送行地址，间隔一段时间再送列地址 why？：DRAM地址位数较多，地址线较多，采用**行列地址线复用**。**这样引脚数可以减少一半**。再加上行通选和列通选信号，占两根地址线
- DRAM芯片连到内存控制器，先送行地址i，DRAM就将第i行所有内容**复制**到内部行缓冲区；再送列地址j，DRAM就将行缓冲区复制除超单元（i,j）中的w位，将其发送到内存控制器
- DRAM封装在内存模块中，多个内存模块连接到内存控制器，聚合成MM

### 2.ROM

**被称为只读是因为历史原因，有一些既能读又能写**

MROM、PROM（一次性编程）

- EPROM：通过紫外线可擦除，因此可进行有限次编程。但写入较慢

- Flash：基于EEPROM，写更快

- 焊在主板上，也属于主存
- 存放BIOS程序（软件，用于电脑开机的引导程序）
- 断电**不**易失

### 3.多模块存储器

**交叉编址**

（1）高位交叉

顺序访问，每一次访问完才轮到下一次



（2）低位交叉

间隔一个**总线传送时间**就启动一个模块，一个模块的存取时间小于等于m*总线传输时间，防止在那时对同一模块的存取发生冲突

模块号（从0开始）=地址%模块数

每个存储周期从0号模块开始读取



第一个体的存取需要占用一个存储周期T，后续每隔一个总线传送周期r就启动下一个体

交叉多体存储器的存储周期不包括总线传送的过程



- 计算**最大带宽**时，不从第一个存储周期算起，即流水线的后面阶段，时间=m*总线传送周期

- 计算一次总线传送事务的时间=T+(m-1)r+r,最后一个r指最后一个体还要多经历一个r(why?)

### 4.与CPU的连接：

地址线、数据线、片选信号、读写信号

（1）位拓展

一次需要选中所有芯片，因此片选信号要与所有芯片相联

（2）字拓展

一次只要部分芯片，因此片选信号通过译码器连接到不同芯片

要区别**主存容量和地址空间**：主存容量一般小于主存地址空间，（比较直观的说明是，主板上还留有内存条的插槽，说明还能扩内存，这部分也算在内存空间内）主存地址空间由MAR的位数决定

### 5.内存中数据存储格式：

- 大端：数据低字节部分存放在高地址部分，高字节存放在低地址部分

- 小端：数据高字节部分存放在高地址部分，低字节存放在低地址部分

记住，大端相反，小端对应

- 按边界对齐：低位交叉多体存储器，要尽量整齐，即占满一行，非规则字会用空白字占满

## 外存

1.磁盘：磁盘控制器和磁盘驱动器的组成，具体见OS

### 2.磁盘冗余阵列RAID

- 将多个独立的物理磁盘组成一个独立的逻辑盘
- 提高可靠性：RAID1，镜像磁盘阵列；RAID3-5,采用奇偶校验

综上，提高RAID的可靠性：1、镜像磁盘阵列 2、数据校验（海明or奇偶）

### 3.固态硬盘SSD

- 基于Flash技术，由Flash芯片组成
- 断电可长期保存信息，可快速擦除和重写
- 随机写很慢：
- 与U盘没有本质上的差别
- 半导体存储器构成，采用随机访问
- 但价格较高，多次擦除重写后容易磨损



## Cache

### 1.工作原理

和主存操作的基本单位：块（和主存一样），里面有很多字

和CPU操作的基本单位：字

操作流程见整个存储系统的流程：读和写

命中率：命中次数/（命中次数+访主存次数）

Cache行的信息：标记（指明在主存中的位置）有效位（信息是否有效）  数据；标记相同且有效位为1时，才说明命中

### 2.和主存的映射

主存地址空间——>Cache地址空间

（1）直接映射

无条件替换，冲突率最高（每个主存块指定到Cache中指定位置），空间利用率最低（即使其它位置有空的也不能放），时间短

地址结构：标记+块号+块内地址

（2）全相联映射

可以装入任何位置，地址中的标记和Cache行中的标记比较速度比较慢，实现成本比较高

地址结构：标记+块内地址

（3）组相联映射

组号固定，组内全相联

地址结构：标记+组号+块内地址

比较器个数=每组内的行数

### 3.替换算法

次数的计算（为空时，调入块算不算一次替换）

- LRU位：LRU算法对每个行设置一个计数器，同来记录主存块的使用情况，计数值的位数=log2(Cache组的大小（一组里有多少块）)，该计数位仅设置在Cache行中。每次访问该行后，要修改该行的LRU位

### 4.写策略

写命中时：

（1）写直通（write through）

成功写入cache时，必须同时把数据写入cache和主存；替换时不需要写回主存

（2）回写法

写入cache时，不需要写回主存

采用回写法时，每个Cache行增加一个修改位（脏位）：为1说明该Cache行修改过，**替换时**需要写回主存。该dirt位设置在Cache行中

写cache未命中时：

（1）写分配：从主存中调块

（2）非写分配：不调块，只写入主存

**写直通—非写分配**

**回写—写分配**

**交叉配对**

## VM

利用主存-外存，基于程序局部性原理，从而实现高速缓存

虚拟存储器提供的空间称为虚拟空间or程序空间，对应逻辑地址（虚地址）；对立的是主存地址空间，对应实地址（物理地址）tip:主存容量+外存容量=虚存容量？？

程序中给出逻辑地址，CPU将逻辑地址映射到物理地址，直接访问主存单元，若在，直接访问；若不在，则从外存中**调入包含该字的整个页or段**

采用**全相联映射**，采用**回写（dirt 位）**

只将当前需要的一部分页面调入内存

### 1.页式（请求分页管理）

**地址结构：**虚页号+页内地址（这里的虚页号是十六进制，页表中的虚页号是十进制，要进行转换）

**地址映射：

①页表（常驻内存），页表项：虚页号+物理页号+修改位（dirt位）+装入位（状态位：是否在内存中）+使用位（访问字段：用于替换算法，类似于LRU位）+物理页地址（物理页在外存的地址）

因此，访问数据需要查找两次内存

②TLB（常驻Cache）：地址转换时，先查快表，快表中没有再查页表；TLB项=页表项+TLB标记（全相联时，即为虚页号；组相联时，为虚页号的高位部分，低位部分为组索引）

**注意：TLB是用来进行快速的地址转换，和数据是否在Cache中无关，只是它自己常驻cache**

块和页的关系：块是物理内存中用来容纳页面的容器？

**地址变换过程**：

TLB缺失时，访问主存查找页表，得到对应页表项，进行地址转换，并将该**页对应的表项**调入TLB，若TLB已满，还需要调用替换算法

页缺失时（所需要的页不在主存），产生缺页中断，从外存中找到所缺的页，并查看内存是否已满：若已满，则使用页面替换算法，若被替换出的页已被修改过（修改位为1），则需要写回外存；若没有满，则OS命令CPU启动IO读取外存数据。整个过程都完全由OS操控。

### 2.段式

见OS

### 3.段页式


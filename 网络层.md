# 网络层

## 网络层功能

### 1.异构网络互联

- 将两个以上的异构计算机网络，用一些中间设备（中继系统）相互连接起来，以构成更大的网络
- 互联后的大网络——虚拟IP网络，简称**IP网络**
- 好处：不用管互联的各网络的具体异构细节

### 2.路由与转发

- 路由选择
- 分组转发

### 3.SDN

- 集中式控制层面+分布式数据层面

- 控制层面通过**集中的控制**-数据接口对路由器进行控制，路由选择由控制层面的**远程控制器**（**逻辑上**）完成，**物理上**由不同地点的多个服务器组成

- 远程控制器掌握各主机和网络的路由状态，为每一个分组寻找最佳路由，为每个路由器创建转发表

  通过openflow协议（控制和数据层面之间的通信接口）将转发表下发给各路由器

- SDN模式：对开发者的编程接口：北向接口

  ​					控制器和转发设备的接口：南向接口

  ​					控制器之间通信的接口：东西向接口
  
- 优点：

- 缺点：1、安全风险：管理集群受到攻击时，全部受影响；2、瓶颈问题：网络规模扩大后，集群控制器成为性能增长的瓶颈



### 4.拥塞控制

## IPV4

### 1.数据报格式

数据报首部包括：（1）固定部分：20B

​                               （2）可变部分：0—40B

**固定部分**中比较重要的参数：（1）首部长度，单位：**4B**，[5,15]

​                                                  （2）首部+数据 总长度，单位：**B**

​                                                  （3）**MF=1** 表示后面还**有分片**，**MF=0**表示**最后一块**分片

​                                                  （4）**DF=0** 表示**允许分片**，DF=1 表示不允许分片

​                                                  （5）片偏移，单位：8B，表示本分片的**起始位置**在整个分片中的偏移量，必须是整数。

**特别注意，当分片后的偏移量不是整数时，需要向下取整，再乘以8，表示本分片重新分片后的长度，所以前后的分片也需要调整长度，可能后面原来没有分片，重新划分后需要增加分片**

​												（6）首部校验和：4B，只校验分组的首部，**不校验**数据

 **数据为什么要分片？**                                 

数据链路层以太网帧的**最大数据传输单元**称为MTU，网络层的数据报的总长度不能超过MTU，因此需要对数据报进行分片

每个分片都包括首部和数据部分

因此对于给定的数据报长度，用数据部分的长度/(MTU-首部长度)表示有几个完整的MTU，要注意数据部分长度必须是8的整数倍



### 2.分类地址

主机号全0表示网络号，全1表示本网络广播地址

127.x.x.x表示回环地址

0.0.0.0表示本网络上的本主机，只能作为源地址

255.255.255.255表示整个网络的广播地址，只能作为广播地址



A类（8+16）：网络号：0...（1-126）

B类（16+16）：网络号：10...（128-191）

C类（24+8）：网络号：110...（192-223）

### 3.子网划分地址

子网和网段的区别？

子网之间通信？

- 子网掩码
- 默认网关：第一个相接的路由器

#### （1）等长子网划分



#### （2）变长子网划分

- 划分原则：

  1.网络前缀不能相同  

  **2.划分的子网要包括全部ip地址**：理解”全部ip地址“的含义，





根据给定的网络号和网络前缀开始划分

例如将101.200.16.0/20划分为5个子网：

若从主机号借用1位作为子网号 则101.200.16.0/21:101.200.0001**0** 000.00000000~0001**0** 111.11111111

若借用两位，则在上述基础上只能从101.200.0001**10** 00.00000000~101.200.0001**10**  11.11111111

借用三位同理



利用创建最小哈夫曼树

### 4.CIDR无分类编址

划线记法：

IP地址/网络号占bit数

动态分配子网

**路由聚合**：找出IP地址公有的部分，其它部分全部置0。有利于减少路由信息的交换

- 路由器的接口ip地址不能算在路由聚合的范围内
- 路由聚合的对象是子网的ip地址
- 直连子网的下一跳填 “-”；其它子网的下一跳填相连的路由器的接口的ip地址

当路由表中有多条可选时，按照最长前缀匹配选择网络前缀最长的

### 5.NAT网络地址转换

装有NAT软件的路由器称为NAT路由器

该路由器隐藏了其连接的网络的细节，

从一个路由器接口发出的数据报具有相同的**源地址**，即NAT路由器联向广域网一侧的接口地址，且在发送和转发过程中源地址不变（从NAT路由器发出后）

发送到NAT路由器的所有数据报有相同的目的地址，即NAT路由器联向广域网一侧的接口地址。之后NAT路由器通过查NAT转换表将该数据报转发给内部网络中指定主机

NAT转换表：（ip地址  端口号|ip地址 端口号）

**如何配置：**

- 路由器发出的所有数据报的源地址都为路由器外侧的接口ip地址，端口是新生成的代替原来的

  因此NAT表 内网写：对应主机号+原来的端口；外网写路由器外侧接口的ip地址+新生成的端口

- 一个主机对应一行，外网的部分的IP地址都是统一的，即路由器外侧接口的ip地址，但是端口号各不相同

**转发过程：**

1.当内部网络中的主机请求因特网中的服务器时，首先为请求报文指定某个端口并将报文数据发送到LAN中

2.NAT路由器收到该报文数据后，为其生成一个**新的端口**，**并将源ip地址改为其连接广域网一侧的接口地址**

3.在NAT转换表中增加该表项

4.因特网收到请求报文，并发送响应报文，目的地址为NAT路由器的接口地址，端口时NAT路由器之前生成的新的端口号

5.该报文到达NAT路由器后，检查NAT转换表，将目的地址和端口号重写为内网的主机的ip地址和端口号

## 路由协议

### 算法基础

#### 距离向量

- 所有结点与其**直接相邻**的结点交换**整个**路由选择表

- 迭代收敛：当有本节点不存在的新路由时，加入该路由；有到相同目的地更短的距离时，替换
- 存在路由环路错误

#### 链路状态

- 网络结构和所有链路开销已知
- 使用Dijkstra算法寻找最短路径
- 最后，所有结点具有网络**统一、完整**的视图



### 1.RIP 路由信息协议

Routing Information Protocol

- 规定到直连网络的跳数为1；每经过一个路由器，跳数+1

- 优先选择**跳数少**的路径

- 最大距离为15，16表示不可达

- 每30s定时广播一次路由表信息

- 只和相邻路由器进行交换；每个路由器只知道自己直到的路由信息，而非整个网络的路由信息

- 存在慢收敛现象：坏消息传的慢

- 应用层协议，使用UDP进行传输（port：520）

- 距离向量算法过程：

  ①收到A发来的RIP报文，先将报文中的下一跳地址改为A的MAC地址，所有距离+1

  ②和本路由器中的路由表进行比较：

  1）若没有某一个目的网络，则添加该表项

  2）若本路由表中有下一跳为A的表项，则用**新的**更新

  3）若本路由表中有相同目的网络但下一跳非A的表项，且距离大于RIP报文中的，则用距离小的替换

  ③180秒没有收到相邻的路由器的RIP报文，则将该路由器标为不可达

  ​                                                              

### 2.OSPF 开放最短路径优先协议

Open Shortest Path First

- 向子网中所有路由器发送路由信息，路由信息包括与本路由器相邻的所有路由器的链路状态（路径和代价）

- **仅当**链路状态发生变化时，才发送

- 网络层协议，用IP数据报传送

- 交换的最终结果是链路状态数据库（全网的拓扑结构图），再根据Dijkstra算法计算最优路径，**即链路状态路由选择算法**

- OSPF分组类型：1）hello分组，建立邻居关系（每隔10s相邻的要交换1次，若超过40s，则认为不可达）

  ​                             2）数据库描述分组：给出链路状态数据库的所有表项的摘要信息

  ​                             3）  4） 5）

  

### 3.BGP 边界网关协议

Border Gateway Protocol

AS之间的协议

- 采用路径向量算法

- 应用层协议，基于TCP

- 过程：1）每个AS至少选择一个BGP发言人 2）发言人之间建立TCP连接，交换**BGP报文**并建立BGP会话，交换路由信息

  ​			3）还会用到AS内部的路由协议，因为BGP的路由信息是要具体到哪一个网络

- 适用于多级结构网络

- BGP报文：1）open报文（建立关系）2）update报文（发送路由信息）3）keepalive报文  4）notification报文

## 其他网络层协议

### 1.ARP协议

Address Resolution Protocol

- IP地址-->MAC地址，存储在ARP高速缓存

- 网络层协议

- 过程：①在ARP表中查询有无目的IP地址，有就将对应MAC地址写入MAC帧；没有就将MAC地址置为全1并广播ARP请求分组

  ​			②目的主机收到后，发出ARP响应分组，包含ip与MAC地址的映射关系

- 若目的主机在同网络，直接查ARP表然后发送；若目的主机不在同一网络，则在ARP表中查询直连路由器的MAC地址，交付给路由器完成

因此发送到不同网络的ip数据报的目的MAC地址为直连路由器的MAC地址

### 2.ICMP协议

Internet Control Message Protocol

封装在IP数据报内，用于报告差错和异常情况

- IP层协议，借助IP数据报
- 报文类型：差错报告报文+询问报文
- 差错类型：终点不可达、源点抑制（由于拥塞而丢弃数据报）、时间超过、参数问题、改变路由

### 3.DHCP协议

Dynamic Host Configuration

- 应用层协议，基于UDP，port:67

- 默认网关：主机的第一跳路由器接口地址

- 作用：为主机动态分配IP地址

- 工作过程：采用C/S模式。

  ①当主机需要IP地址时，向DHCP服务器广播**“DHCP发现”报文**，且只有DHCP服务器会回答。

  ②DHCP服务器在其数据库中查找该计算机的配置信息，若有，则返回找到的信息；若没有，则从IP池中取一个，并广播**“DHCP提供信息”**，其中包括返回的IP地址；

  ③主机收到该信息后，若接收该IP地址，就广播**“DHCP请求信息”**

  ④DHCP服务器广播**“DHCP确认信息”**，将IP地址分配给主机

  注意：只有最后两个步骤是实际必要的

- DHCP收到多个请求时，一般只会响应最先到达的；分配的IP地址的**使用期是有限**的



## IP组播

- 针对多媒体应用，应用于UDP
- 一个分组可以到达多个有**相同组地址**的主机
- 主机可以选择加入or离开一个组，一台主机可以同时属于多个组
- 组播地址**后23bits**映射到MAC地址
- 地址范围：２２４.０.０.０～２３９.２５５.２５５.２５５





## IPV6

- 从根本上解决了IP地址耗尽问题
- 地址128bits，16进制表示；不允许分片；**身份验证&保密功能**；自动配置
- 能向IPV4兼容：①双协议栈技术 ②隧道技术：将IPV6字段封装到IPV4的数据部分

## 移动IP

可能会考。。猜的

- 组成：1）移动结点：IP地址永久不变 2）本地代理：  3）外部代理

- 需要连接到因特网，基于互联网中的路由协议

- 通信过程：①在本地子网时，按TCP/IP协议通信

  ​                   ②漫游到外地网时，IP地址不变。但移动结点需要向本地代理注册当前的**位置地址（转交地址）**

  ​				   ③本地代理构建一条通向转交地址的隧道，将截获原来发给移动结点IP地址的分组转发给转交地址





## 路由器

- **冲突域：**连接到同一物理介质上的集合，只有物理层设备（集线器、中继器）无法隔离冲突域，往上都可以
- **广播域：**接收同样广播信息的集合，集线器、交换机无法隔离广播域，

### 1.路由选择

- 路由选择处理机：根据路由协议构造**路由表**，并定期和邻居交换路由信息，更新和维护路由表

  | 目的IP地址 | 子网掩码 | 下一跳IP地址 | 接口 |
  | ---------- | -------- | ------------ | ---- |
  |            |          |              |      |

  若网络与路由器直连，则下一跳地址为直连

  

- 对于发送给互联网的路由，**目的ip**和**子网掩码**都为0.0.0.0

- 没有说明分了子网，那么子网掩码就填255.255.255.255

### 2.分组转发

-  根据转发表将IP数据报从合适的端口转发出去

- 组成：交换结构，一组输入端口（从物理层接收到的比特流中提取帧，进而提取数据报），一组输出端口
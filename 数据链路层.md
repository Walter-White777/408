# 数据链路层

## 成帧

- HDLC标准帧格式：标识位F表示帧的开始和结束

## 差错控制

### 1.检测错误

**（1）奇偶检错**



**（2）CRC循环冗余码**

发送方和接收方**事先商量**好一个多项式G(x)

余码=原数据<<（G(x)的位数-1）mod G(x)  (**特别注意，这里的除法采用模2除法，即每一位进行异或运算**)

循环冗余码=原数据<<（G(x)的位数-1）+ 余码

### 2.纠错

**海明码：**

纠1位错，需要k位检验码；纠2位错，需要k+1位错...以此类推

数据位数n和k的关系：n+k<=2^k-1

第i位校验码在海明码的2^(i-1)位上



## 流量控制

**必须满足**的是

Wt >= Wr

Wt+Wr<=2^n

### 1.停-等协议

发送和接收窗口大小都为1

发送窗口每收到接收方发来的确认信号后，发送窗口才能向前移动一位，因此就陷入：发送一帧----等待----收到确认帧----发送窗口向前移

效率低下

### 2.回退N帧协议（GBN）

滑动窗口的序号是重复使用的，注意区别于TCP的序号

- 发送窗口Wt：（1,(2^n)-1],n为**帧序号**比特位数

  ​		序号的范围为0-2^n

**发送窗口内**的分组可以连续发送，而不需要接收到确认帧才能发送下一个；收到一个确认帧后，发送窗口向前移动一格

- 接收窗口Wr=1

- 可靠传输：

采用**累积确认机制**：由于接收方正确接收到一个分组，就**按序**向上递交一个。接收到这连续帧的数据的最后一帧的确认信息 ，发送窗口就整体向前移动一位。因此当收到**ACKn**帧，说明前面的n帧全部正确接收，接收方希望发送方发送第n+1帧

**发生超时：**接收方丢弃失序分组，发送方重传所有**已发送但还未收到确认**的分组

当某一帧发生错误时，发送方可能已经把整个窗口内的所有帧都发送了过去，接收方就需要把错误帧之后的所有帧全部丢弃，发送方需要将这一帧及之后的所有帧重新发一遍。这非常影响效率

题目中问到需要重新发送几帧时，只需要发送最后到达的确认帧之后对应的数据帧，e.g.：

发送方发送了0-6号帧，但只收到了1,3,5号帧：

只需要重发第6号帧，0,2,4号**确认帧**可能在发送过程中丢失，

### 3.选择重传协议（SR）

1<Wr<=Wt<=2^(n-1)

采用**单帧确认机制**：当怀疑某一帧出错时，接收方发送**NAK帧（否定帧）**给发送方,**指定这一帧重发**即可

发送方需要对**没有收到确认帧所对应的帧**进行重传，即对超时的分组



### 4.传输效率的计算

- 传输效率（信道利用率）=（发送方）传输有效数据的时间/**一个发送周期**（即**开始发送数据到收到第一个确认帧**）,开始发送数据指**传输已经完成**，全部的数据已经在信道上

  因此**最短的发送周期**即为**第一个帧**的传输时延+双向的传播时延，常涉及最大传输效率、最大传输速率

​               =(窗口内数据的总长度/传输速率)/(单个帧数据的长度/传输速率+2*单向传播时延)

- 有效数据传输：指传输以太网数据帧的数据部分，即要1500B的数据部分，要除去18B的首部开销

## 介质访问控制（MAC）

关于被共享的**广播信道如何被分配**的协议

### 1.信道划分访问控制

本质上是一种信道多路复用的技术

#### （1）FDM（频分复用）

将信道的带宽分为多个不同的频率范围（多个信道），各个频率范围的带宽供容纳一个信号进行传输，每个小信道之间有“保护频带”，防止相邻信道之间相互影响。不同的信号可以**同时**在一条公共信道上进行传输



#### （2）TDM（时分复用）

每个信号独占信道一段时间





#### （3）WDM（波分复用）





#### （4）CDM（码分多路复用）

- 应用于WLAN和蜂窝技术

- 每个站点有其固定的码片序列，不同站点之间的码片序列互相正交。

- 与码片序列相同的表示1，各位相反的表示0

- 在公共信道上传输的可能是多个站点发送的向量进行线性相加后得到的结果

- 需要将接收者接收到的序列与发送者的码片序列进行规格化内积运算：如为1，则说明发出的数据是1；如为-1，则说明发出的数据为0

  **注：规格化内积=1/m∑（Si*Ti）,即在普通内积的结果上，除以发送者码片序列的位数**











### 2.随机访问控制

发送方随机发帧

#### （1）ALOHA

有数据就发，并用计时器进行计时，超过某个时间没收到确认就认为发生冲突。

经过一段随机的时间再进行重发

#### （2）CSMA

发送前先监听信道

1）1-坚持

信道空闲就发送；忙就持续监听，**直到**空闲

2）0-坚持

信道空闲就发送；忙就不继续监听，过一段时间再监听

3）p坚持

信道空闲以p的概率发送，1-p的概率到下一个时隙；忙就持续监听，直到空闲 

#### （3）CSMA/CD

边发送边监听，监听到碰撞就停止发送

什么时候能监听到碰撞呢？并不是刚发生碰撞发送方就能监听到，直到被碰撞的数据到达发送方时，才能知道发生了碰撞。（本质上是被碰撞的数据发送了向对方发送了冲突信号）

因此，最多经过2*单向传播时延（即到目的地接收时才发生碰撞） 能知道发生碰撞

为能检测到所有碰撞，最短帧长需满足L>=2t*C（t为单向传播时延，C为传输速率）

由于以太网帧长最短为64B，因此两个节点之间的最长距离为64B/(2*C) *传播速率

- 采用二进制退避算法：

k=min(10,重传次数)，r=rand(0,2^k-1)

退避时间=2*传播时延 *r

- 适用于有线局域网

#### （4）CSMA/CA

- 用于无线局域网，采用CA(碰撞避免)，尽量降低碰撞发生的概率（而非无碰撞）

- CA：所有结点发送完毕后，要等待**IFS（帧间间隔）**后，才能发送下一帧

- IFS：1）SIFS：最短，分隔对话帧（**ACK**，CTS帧，分片数据帧）

  ​         2）PIFS：中等长度

  ​         3）DIFS：最长，用于不同站点竞争信道时用到（RTS帧）

- 信道预约：发送数据前先**广播**一个**RTS**（请求发送）控制帧（源地址，目的地址，发送时间），若信道空闲，则接收站广播CTS（允许发送）控制帧（从RTS帧复制发送时间），其它站点收到CTS帧后，在这个时间内抑制发送

- 完整过程：①最初有数据要发（非重传），检测信道空闲后的DIFS时间后，发送**整个**数据帧

​                         ②若信道不空闲，退避计时器随机选取一个退避值，并且一直检测信道，若空闲，则退避计时器开始计时，减到0后，就发送帧

​						③接收方收到数据后，用CRC校验数据是否正确，若正确则返回ACK确认帧。因此CSMA/CA是**可靠的**

​						④发送方收到ACK后，如果要继续发送，从第二步开始；如果没有收到，则在更大范围内选取退避值

<img src="C:\Users\gjys\AppData\Roaming\Typora\typora-user-images\image-20221208202919616.png" alt="image-20221208202919616" style="zoom: 33%;" />

- 半双工



### 3.轮询访问控制

- 用令牌（特殊的MAC控制帧）确保只有一个结点独占信道
- 令牌按顺序依次传递
- 主要用在令牌环局域网中。适合负载高的广播信道



## 局域网

### 1.802.3 以太网

- 逻辑上总线型拓扑结构，并使用**CSMA/CD**对总线进行访问控制

- 无连接、不可靠

- 数据采用曼彻斯特编码

- 传输介质：1）粗缆（5）500m 2）细缆（2）185m  3）双绞线（T）100m  4）光纤（FL）2000m

- 以太网MAC帧：

  | 目的地址      | 源地址          | 类型 | IP数据报                            | FCS      |
  | ------------- | --------------- | ---- | ----------------------------------- | -------- |
  | 6B（MAC地址） | ６Ｂ（MAC地址） | 2B   | 46-1500B（46是当数据为0时的填充码） | 4B校验码 |
  
  以太网帧长度：64B~1518Bwhy？：
  
  
  
  **MAC地址会随着到达不同的路由器而发生变化，具体来讲：**
  
  主机发往网关路由器的以太网帧的目的MAC地址为路由器的内侧接口的MAC地址
  
  路由器发往主机的以太网帧的源地址为路由器接口的MAC地址
  
- 高速以太网：1）100BASE-T：双绞线，10^8b/s，CSMA/CD，星形拓扑结构

​                             2）千兆以太网：10^9b/s

​                             3）10吉比特以太网：只用光纤，全双工（不使用CSMA/CD）



### 2.802.11 无线局域网

- **CSMA/CA**，星形拓扑结构

- 802.11局域网MAC帧：

  | MAC首部             | 数据    | FCS      |
  | ------------------- | ------- | -------- |
  | 30B（带4个MAC地址） | 0-2312B | 4B校验码 |

  只关注前3个地址：

  ①地址1：数据帧的直接接收地址

  ②地址2：数据帧的实际发送地址

  ③地址3：源地址or目的地址

  例如A->B,AP在AB中间，A发送给AP的MAC帧中：

  **发送给AP：**

  去往AP=1，来自AP=0，地址1=AP地址，地址2=A的MAC地址，地址３＝B的ＭＡＣ地址

  **接收AP：**

  去往AP=0，来自AP=1，地址1=B地址，地址2=AP地址，地址3=A地址



### 3.VLAN

- Virtual LAN

- 将较大的局域网划分为较小的**逻辑上**的VLAN

- 划分方法：1.基于端口 2.基于MAC地址 3.基于IP地址

- 每个VLAN是**一个**广播域，既可以隔离冲突域也可以隔离广播域

- 802.1Q帧：在以太网帧中插入4B的**VLAN标签**，标识属于哪个VLAN

  VLAN标签：

  前2B：固定0x8100。代表是802.1Q帧

  后2B：前4bits无用；后12bitsVID**唯一**标识属于哪个VLAN，因此可以识别4096个VLAN

- 帧中的FCS校验字段必须重新计算

- 同一个VLAN可以跨越不同的交换机 （跨局域网）。交换机必须能识别VID，从而交付给对应的VLAN

- 主机交给交换机的都是普通的以太网帧，交换机负责在以太网帧中插入和拿走VLAN标签，再转发给对应的目标主机。因此802.1Q帧只在交换机之间传输，交换机与主机之间传送的都是标准的以太网帧

- 是一种服务，而非新的局域网

- 优点：有利于信息安全；简化网络管理；共享了网络资源

## 广域网

- 因特网的**核心**部分
- 将各结点交换机用长距离高速链路连接起来
- 结点交换机：存储转发分组
- 主要使用了网络层协议
- 结点之间通过点到点的方式连接
- 涉及物理层、数据链路层、网络层
- 强调资源共享



### PPP协议

- 建立点对点连接发送数据

- PPP帧：

  | 首部 | 数据                  | 尾部                 |
  | ---- | --------------------- | -------------------- |
  | 5B   | IP数据报，不超过1500B | FCS（CRC冗余码），3B |

- 只通过硬件进行CRC检错，不纠错

- 不可靠，没有确认机制

- 仅支持全双工

- 面向字节

- 两端可以运行不同的网络层协议

- 采用字节填充法



## 数据链路层设备

### 网桥

两个或多个以太网通过网桥连接

### 局域网交换机（switch）

多端口的网桥

将多个网段连接起来，每个端口连接一个网段？，这些网段仍然**同属于一个局域网**。每个网段自成一个冲突域（即**隔离了冲突域**），并且**独占和交换机的信道**，一般工作在全双工模式（半双工题目中会说）

但是**没有隔离广播域**，这也是交换机自学习算法能实现的前提

**交换方式：**

（1）直通式：只检查帧的目的地址，即**只检查6B的目的地址**，因此交换延迟为 6B/传输速率

（2）存储转发式：检查整个帧数据，即**完整的帧数据**（64B~1512B）

**自学习算法：**

1.A结点向B结点发送数据时，先通过与交换机的接口h1将帧数据交给交换机。

2.交换机再查找交换表，若交换表内有B对应的MAC地址，则向对应的接口进行转发；若没有，则向所有的主机广播（**除主机A外，主机本身不算在广播范围内**）。

3.在交换表中写入（A的MAC地址，h1）

4.B向A发送确认帧，（**如果A所在的网段内还有其它由hub连接的节点，则这些节点都会收到该确认帧**）。交换机收到确认帧后，由于交换表内有A对应的表项，因此**直接发给A**，不需要广播





***同一个冲突域（集线器or转发器为中心的网段）**的任一结点发送数据，网段内所有结点（包括发送节点都会收到数据，因为没有隔离冲突域和广播域）
# 传输层

## 概述

第一个端到端的层

套接字：ip+端口，可以区别不同主机中的不同进程，因此是唯一表示

端和端点的区别



## UDP协议

### 数据报格式：

- 源端口号：2B
- 目的端口号：2B
- 长度：2B
- 校验和：2B

**因此，首部固定长度为8B**

- 数据部分（报文）



### 应用：

- DNS
- SNMP
- 流式多媒体
- NFS（远程文件服务器）



### 特点：

- 无连接；无需确认，因此不可靠
- 应用层数据封装进UDP报文后**立即**传递给网络层，能容忍一些数据丢失
- 分组首部开销小



### 多路复用/分解

- 多路复用：不同套接字的数据块合成报文的数据段
- 多路分解（分用）：将报文段中的数据交付到不同的**套接字（ip：port）**

因此，多路复用通过源端口号实现；多路分解通过目的端口实现

### 差错校验

## TCP协议

### 报文段：

TCP首部：

- 源端口和目的端口：各占2B
- 序号seq：按**字节编号**，占4B，指报文段的**第一个字节**的序号
- 确认号ack：按字节编号，占4B
- 数据偏移：单位4B，即首部长度，占4bits
- 接收窗口rwnd，表示接收方的接收缓存中剩余的空间
- 标志：PSH：尽快交付给应用进程
- **固定部分20B**，加上填充部分使整个首部长度为4B的整数倍



### 1.连接管理

#### （1）建立连接3次握手

（1）客户端发送SYN报文段，SYN=1，ACK=0，表示请求连接。**消耗一个seq序号，但是其中并不带有数据**。进入SYN-SENT状态

（2）服务端发送确认段，SYN=1，ACK=1，表示同意连接。**消耗一个seq序号，但是其中并不带有数据**。进入SYN－RCVD状态

（3）客户端给出确认，ACK=1，（注意没有SYN字段）连接建立。若不带数据，则不消耗序号；若带数据，则消耗序号。进入ESTABLISHED状态

因此无论第三次握手是否消耗序号，计算发送的字节数都是从第一个SYN段的序号+1开始算起

#### （2）释放连接4次握手

TCP连接是全双工通道，要断连两次

（1）客户端先发送**FIN=1**的报文段，之后不能发送数据，但是服务端还可以发送数据。等待服务端的确认报文。处于FIN_Wait1

（2）服务器发送上述的确认报文段

（3）服务端向客户端发送FIN=1的报文段，ACK=1，ack=（2）中的确认号

（4）客户端收到释放连接报文段后，向服务端发送确认报文，seq=(3)中的确认号。**注意：此时连接还未释放，必须等待确认报文的计时器到时，此时处于Time_wait状态**，因为若不等待的话，当该确认帧在传播过程中丢失时，客户端此时已经关闭，无法向服务器端发送FIN段，服务器端就一直等待浪费了资源

![image-20221022200356200](C:\Users\gjys\AppData\Roaming\Typora\typora-user-images\image-20221022200356200.png)

**注：**以上两者最少占3个RTT

### 2.流量控制

接收方有接收缓存（RcvBuffer）,rwnd表示其中空闲空间的大小，即还能接收多少字节

当接收方发送ack=k,rwnd=w的报文，指发送方还能发送从k开始的共w个字节

但是发送方可能并不是立即发送序号为k的数据报，因为可能该数据报在传输过程中丢失，需要超时或者连续收到3次k的冗余ACK报文，才会重新发送序号为k的报文，**否则只会发送k后面的报文段**



### 3.拥塞控制

发送窗口=min（cwnd，rwnd）

rwnd会随着发送方的**每次**发送而减少，在拥塞控制算法上的体现是：拥塞窗口cwnd在指数增加时，每次发送成功后，rwnd随之减少，当减少到比当前的cwnd小时，发送窗口就要取rwnd的大小

（1）慢开始：cwnd从1开始，呈2的指数次增加：1，2，4，8..直到慢开始阈值ssthresh

本质上：是因为第一次发送1个报文段收到该报文段的确认后，cwnd++，发送窗口变为2，然后在1个RTT内发送2个报文段（发送窗口内的报文段可以连续发送），先后接收到这两个报文段的确认后，cwnd+=2.因为每收到一个报文段的确认，cwnd+1，所以看起来是2次方的增长

（2）拥塞避免：从阈值开始，cwnd线性增加（每次加1），直到发生超时拥塞

此时，cwnd的增长是以所有上次发出的报文段全部确认后，增加1

**并且**并不能完全避免拥塞

（3）重置：慢开始阈值ssthresh变为**发生超时时cwnd的一半**（不能小于2），且 cwnd重置为1，从（1）开始

（4）快恢复：与上述的唯一区别在于cwnd重置为**发生超时时cwnd的一半**，并直接开始拥塞避免（线性增长），跳过慢开始阶段

适用条件：当连续收到3个**冗余ACK**时

**注意：每次状态的变换的间隔都是一个RTT**

### 4.可靠传输

（1）确认：累积确认。接收方会**一直发送**理应收到但未收到的报文段的序号(第一个丢失的字节)。

对于收到的失序报文段，实际应用中将其保留下来，等待缺少的字节填补

（2）重传：1.计时重传：每发一个报文段，就启动计时

​                     2.快重传：发送方收到3个对同一个报文的确认段。时间比计时要短
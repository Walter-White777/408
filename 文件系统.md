# 文件系统管理

## 文件

文件（记录（数据项））

文件属性（不同OS下不同）：

- 文件名：同一路径下的文件名唯一
- 大小
- 位置

物理设备也可以作为文件

**文件元数据**

### 文件控制

**1.文件控制块FCB：**

- 每一个文件对应一个FCB，以实现对文件的按名存取
- 存放在**文件目录**中，aka目录项
- 包括：基本信息（文件大小、文件名、文件起始位置、结构），存取控制信息（存取权限），使用信息（创建时间、上次修改时间）
- 在磁盘中必须连续存放

**2.索引结点：**

- 每个文件与磁盘索引结点**一一对应**

- 在文件目录中查找文件只需要用到文件名，**不需要**将所有FCB的所有信息**都调入内存**，文件目录中也不需要放所有的文件描述信息 

- 除文件名外的**文件描述信息**放在**索引结点**中（aka **i结点**）。

  文件目录项变为（文件名，指向对应**i结点**的指针）

- 磁盘索引结点：**没有文件名**，文件物理地址（iddr(0)~iddr(12)），文件长度（B），指向该文件的文件名的指针数等

- 内存索引结点：拷贝磁盘索引结点到内存，并增加：访问计数等

**3.文件操作：**

- 对文件的操作需要用OS提供的系统调用

- 文件打开：使用系统调用open()，将文件属性复制到内存的**打开文件表**中，并将表目的编号（unix中为文件描述符，Windows中为文件句柄）返回给用户；再次请求时，先到文件打开表中查找

  每个进程有一个文件打开表；系统有一个文件打开表，每个表项唯一，对每一个表项附带共享计数器，当为0时才能删除。单个进程的打开文件表每一个条目指向系统的打开文件表的相应条目
  
  首次打开文件时，需要使用系统调用open()，返回打开文件表中的一个条目的指针

### 文件保护

口令保护：

- 建立FCB时增加相应的口令
- 口令直接在系统内部，不安全

加密保护：

- 直接的文件进行加密，访问需要密钥

**访问控制：**

- 每个文件和目录有一个访问控制表
- 创建文件时说明其拥有者和组别



### 文件结构

#### 1.逻辑结构

**1.顺序文件：**

- 记录一个接一个顺序排列
- 适合批量操作；对于单个记录的操作，性能较差

**2.索引文件：**

- 对于变长记录文件，建立索引表，文件的每个记录在索引表中有对应的表项（索引号，长度，指针）

**3.索引顺序文件：**

- 在顺序文件的基础上，对记录进行分组，为每个组的第一条记录建立索引
- 组与组之间的关键字必须有序（索引表查找时可以加快检索速度）；组内的记录的关键字可以无序

**4.散列文件**

- Hash（key）=物理地址

#### 2.物理结构（存储结构）

**1.连续分配**

- 每个文件在磁盘上占用一组连续的磁盘块
- 支持顺序访问和直接访问（随机访问），只适合长度固定的文件
- 访问文件的各块时，基本不需要移动磁头，移动也是相邻磁道之间移动
- 不宜动态增加长度；增删文件后容易产生磁盘块碎片
- FCB中记录文件的<起始位置，长度>

**2.链接分配**

- 隐式链接：文件目录项中有**起始位置**和**结束位置**；每个盘块有指向下一个盘块的指针，链式连接
- 只支持**顺序**一个一个next查找，每一个指针的访问都需要磁盘读，甚至是磁盘寻道。随机访问效率很低；指针存在隐患
- 解决方法：将**多个盘块**组成簇 来分配



- 显式链接：文件分配表FAT（盘块号，next），文件目录项中存放起始块号；next用-1表示文件的最后一块，其它数字表示是空闲的（-2，-3..）
- FAT表在**整个磁盘中只有一张**。存放在每个卷的开头部分
- FAT表在系统启动时会被加载到内存中，加快了检索效率

**3.索引分配**

- 每个文件的**所有盘块号**都放在一个盘块（索引块）中
- 每个文件都有对应的索引块，文件目录项中存放的时**索引块的盘块号**
- 支持随机访问
- 浪费空间；索引块指针开销大于链接分配的指针

**4.混合索引分配**（重要）

- iddr(0)-iddr(9)直接地址，存放文件盘块号
- iddr(10)一级间址：该地址指向索引块，索引块包含文件的所有盘块号
- iddr(11)之后多次间址：

|          | 连续分配           | 链接分配 | 索引分配 | 混合索引分配 |
| -------- | ------------------ | -------- | -------- | ------------ |
| 访问速度 | 支持随机访问，最快 | 最慢     | 第二     |              |
| 修改     | 不方便             | 方便     |          |              |
|          |                    |          |          |              |
|          |                    |          |          |              |





## 目录

定义：FCB的有序集合

### 目录结构

**1.单级目录结构：**

- 整个文件系统只有一张目录表，一个目录项是一个文件的FCB
- 按名存取，不允许重名

**2.两级目录：**

- 主文件目录（用户名+对应用户的**文件目录**的位置）+用户文件目录（文件名+FCB）
- 缺乏灵活性，不能对文件分类

**3.树形目录结构：**

- ./表示当前目录
- 每个进程有一个当前目录
- 便于文件分类和管理
- 查找文件需要进行多次磁盘块的IO；不便于实现文件共享

**4.无环图目录结构：**

- 多条有向边指向同一个文件
- 为每个共享文件设置一个计数器，保存指向其的共享链数
- 文件目录项（文件名，指向索引结点的指针）

### 目录操作

- 删除操作：当前目录和其子目录同时删除

### 文件共享

**1.硬链接：**

- 共享链指向文件的索引结点，索引结点中有**共享计数**count,文件**所有者**
- 当源文件删除时，新建文件仍然可以使用
- 文件所有者从始至终保持不变
- 与普通文件没区别
- 删除所有后文件实体才能被删除
- 建立一个硬链接，引用计数值加1

**2.软链接：**

- LINK类型的文件(快捷方式)，将该文件的FCB写入共享者的文件目录
- 该文件的内容是目标文件的路径
- 建立符号链接时，引用计数值**直接复制**
- 原文件删除后不可以访问，但是软链接本身并不知道，因此引用计数值不改变
- 可以跨磁盘分区

![Linux硬链接和软连接的区别](https://xzchsia.github.io/img/in-post/linux-hard-soft-link/linux-soft-hard-link-diff.png)

## 文件系统

### 文件系统全局结构





### 外存空闲空间管理

- 空闲表法：
- 空闲链表法：
- 位示图：盘块号b=n*(i-1)+j,n为位示图每行的位数，i为行数，j为列数  **注意，该计算方法是在行列从1开始编号的情况下，从0开始编号要有所变化**
- 成组链接法：

### VFS

- 超级块对象：整个文件系统
- 索引结点对象：一个单独的文件
- 目录项对象：单个目录项
- 文件对象：表示一个已经打开的文件

### 文件系统挂载

## 提高文件访问速度的方法：

1.改进目录结构和目录检索方法

2.选取合适的文件结构

以上两点在文件结构和目录中已有涉及

3.提高磁盘的IO速度：

- 磁盘高速缓存：经常访问的数据放在内存的磁盘高速缓存中
- 提前读：预测下一个盘块可能会访问，提前读到内存中
- 延迟写（异步写）：修改过的块一起写回磁盘，减少对磁盘的访问
- 随后释放：请求下一个页面，就从缓冲区中删除一个页面
- 优化物理块分布：尽量将同一个文件的块分布在连续的磁道上，消除寻道时间
- 虚拟盘：用内存仿真磁盘，一般用于存储临时文件
- RAID
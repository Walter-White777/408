# 设备管理



## IO管理基础

#### 设备分类：

**按信息交换单位：**

- 块设备：磁盘。随机读写任一块
- 字符设备：打印机、交互式终端机。采用中断IO；

**按传输速率：**

- 低速：键盘、鼠标
- 中速：激光打印机
- 高速：磁盘机、光盘机



#### IO接口和端口

**接口：**

- I/O接口是一种**设备控制器**（特别注意**控制器！**）判断是不是I/O接口

- 组成：

  （1）CPU与控制器接口：包含三条信号线**（其中数据线既传输数据，又传输设备状态信息和cpu的控制命令（包括中断信号和类型号））**，数据寄存器，控制/状态寄存器

​	（2）I/O逻辑（对控制命令和地址码进行**译码**，选择相应设备进行控制）

​    （3）控制器与设备接口（在一个控制器中有一个或多个，连接多个设备）

- 端口





## IO软件层次结构：

- 用户层IO软件：利用系统调用调用OS内部的IO软件
- 设备独立性软件：实现用户和设备的统一接口，使应用程序独立于具体使用的物理设备
- 设备驱动程序：接受上层抽象IO要求，转换为具体要求后，发送给设备控制器；反向同理
- 中断处理程序：



## IO应用程序接口

- 字符设备接口：中断方式
- 块设备接口：DMA方式
- 网络设备接口：网络套接字接口，其系统调用使应用程序创建的本地套接字能连接到远程应用的套接字
- 阻塞/非阻塞IO

## 设备独立性：

- 含义：用户程序独立于具体使用的物理设备
- 优点：物理设备更换时，无需改变应用程序；提高设备分配的效率

### 磁盘高速缓冲&缓冲区

**磁盘高速缓冲：**

利用**内存空间**来暂存从磁盘中读出的信息,用于提高磁盘的IO速度

**单缓冲：**

- 主存中设置**一个**缓冲区，缓冲区和工作区的大小默认相等
- 必须等工作区空且缓冲区满时，才能传送数据，所以用时：max（T,C）+M  (T为外围设备输入缓冲区的时间，C为工作区的数据处理完毕的时间，M为缓冲区传送到工作区的时间)

**双缓冲：**

- 外围设备先输入到buffer1,填满后再输入到buffer2，此时处理机可以从buffer1读数据送入用户进程，buffer2满了之后又可以从buffer2读数据，实现了并行输入
- 当一边的缓冲区读取完数据并且处理完之后，用时C+M，外围设备填入另一边的缓冲区的时间为T，必须等一边完成后，才能进行另一边的工作，所以用时：max（C+M，T）
- **注意:必须等缓冲区2填满后,处理机才能从中读取**

**循环缓冲：**

循环缓冲链

**缓冲池：**





### 设备分配与回收

- DCT(设备控制表)：一张表代表一个设备，每个表项代表设备的属性
- COCT（控制器控制表）：一张表代表一个控制器，其中有指向相应通道表的指针，一个通道对应多个设备
- LUT(逻辑设备表)：（逻辑设备名，物理设备名，设备驱动程序入口地址），将逻辑设备名映射为物理设备名，从而实现虚拟设备。同一张LUT中逻辑设备名不能重名

### SPOOlLING技术

- 组成：磁盘上的输入井和输出井，内存中的输入和输出缓冲区，输入和输出进程
- 过程：1）将要打印的数据先送入输出井 2）为该进程申请用户请求打印表，将要求填入该表中，再将该表挂到假脱机文件队列上
- 特点：空间换时间、独占设备->共享设备、提高了IO速度



### 设备驱动程序接口

## 磁盘管理

- 结构:磁盘驱动器（磁头组件+盘片组件）、磁盘控制器、盘片

- 磁盘地址：驱动器号+柱面号+磁头号+扇区号

  柱面号=簇号/每个柱面的簇数

  磁头号=簇号%每个柱面的簇数/每个磁道的簇数

  扇区号=簇号%每个磁道的扇区数

- 扇区（aka块）是磁盘读写的最小单位

- 计算磁盘地址由磁盘驱动程序实现

- 读写是**串行**的



**1.初始化**

- 物理格式化：将磁盘**分成扇区**，以便磁盘控制器能进行读写操作

**2.分区**

- 1）将磁盘分为多个分区(C盘、D盘的形式)
- 2）对物理分区进行**逻辑格式化（创建文件系统）**，OS将初始的文件系统数据结构存储到磁盘上

**3.引导块：**

- **ROM中存放自举程序**
- 磁盘上有一个引导分区，存储os和设备驱动程序。
- 0号分区（MBR）中包含**磁盘引导代码**和磁盘分区表
- 磁盘引导程序指示到活动分区
- 到活动分区后，执行分区中第一个**扇区的引导程序**，用于引导该分区的OS。
- 将OS内核装入内存（RAM），然后OS开始运行
- **总结：**ROM中的引导（自举）程序-->MBR中的磁盘引导程序-->分区的引导程序-->OS初始化

**４.坏块：**

- 简单磁盘：手动处理
- 复杂磁盘：维护坏块列表，避免去使用

### 磁盘调度算法

- 寻道时间：
- 旋转延迟时间：1/（2*r），r为转速
- 传输时间：传输字节数/

存取时间=寻道时间+旋转延迟+传输时间

**1.FCFS：**

- 无磁臂粘着现象（why？）



**2.SSTF：**

- 频繁增加在当前磁道附近的磁道请求，产生**饥饿**现象

  区分**饥饿**现象和**磁臂粘着**：

  1）饥饿指一个磁道请求长期不被响应

  2）磁臂粘着指某个磁道的**连续请求**导致**磁臂不动**，导致其它磁道请求不被处理



**3.SCAN：**

- 在磁头**当前移动方向**上选择**最近**的磁道请求
- 移到头后，换方向
- 无饥饿现象，但是存在磁臂粘着现象：一直出现某个磁道的请求

**4.C-SCAN：**

- 在SCAN的基础上，移到头后，直接移到起始端（0号磁道）
- 无饥饿现象，但是存在磁臂粘着现象：



### 固态硬盘

- 读写性能特性
- 磨损均衡